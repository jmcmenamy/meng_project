#!/bin/bash

# Define the path to the virtual environment (hardcoded)
SCRIPT_DIR=$(cd "$(dirname $(readlink -f "$0"))" && pwd -P)
VENV_PATH="${SCRIPT_DIR}/venv"
SCRIPT_PATH="${SCRIPT_DIR}/dstest.py"

# Should we deactivate at the end?
ACTIVATED=false

# If a venv folder exists and has an activate script, source it
if [ -f "$VENV_PATH/bin/activate" ]; then
    source "$VENV_PATH/bin/activate"
    ACTIVATED=true
else
    echo "Notice: No virtual environment at $VENV_PATH â€” running system Python"
fi

# so the rich module in Python update the progress dynamically
export TTY_COMPATIBLE=1

# Run dstest with all arguments passed to this script, capture all output.
OUTPUT=$(python3 -u $SCRIPT_PATH "$@" | tee /dev/tty)

# Extract the result path from the output.
# This assumes the Python script prints a line like:
#   RESULT_PATH: /path/to/output
RESULT_PATH=$(echo "$OUTPUT" | grep '^RESULT_PATH:' | awk '{print $2}')

# Iterate over each subfolder in RESULT_PATH.
if [ -d "$RESULT_PATH" ]; then
    for subfolder in "$RESULT_PATH"/*; do
        if [ -d "$subfolder" ]; then
            echo "Processing subfolder: $subfolder"
            GoVector --log_type zap --log_dir "$subfolder" --outfile "$subfolder/combined_logs.log"
        fi
    done
else
    echo "Error: RESULT_PATH is not a directory: $RESULT_PATH"
fi

# Only deactivate if we actually activated earlier
if [ "$ACTIVATED" = true ]; then
    deactivate
fi